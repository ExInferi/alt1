!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@alt1/base")):"function"==typeof define&&define.amd?define(["@alt1/base"],t):"object"==typeof exports?exports["@alt1/ocr"]=t(require("@alt1/base")):e.OCR=t(e.A1lib)}("undefined"!=typeof self?self:this,function(e){return function(e){var t={};function r(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(a,n,function(t){return e[t]}.bind(null,n));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/",r(r.s=0)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=r(1);function n(e,t,r,a,n,i,o){var d=Math.min(50,o/(1-o)),s=e+(e-a)*d,h=t+(t-n)*d,l=r+(r-i)*d;return Math.max(-s,-h,-l,s-255,h-255,l-255)}function i(e,t,r,a,n,i,d,s,h){var l=n*h-s*i,u=i*d-h*a,c=a*s-d*n,f=255/Math.sqrt(l*l+u*u+c*c);return o(e,t,r,a,n,i,d,s,h,l*=f,u*=f,c*=f)}function o(e,t,r,a,n,i,o,d,s,h,l,u){var c=d*u-s*l,f=s*h-o*u,p=o*l-d*h,g=a*c+n*f+i*p;return[(c*e+f*t+p*r)/g,((l*i-u*n)*e+(u*a-h*i)*t+(h*n-l*a)*r)/g,((n*s-i*d)*e+(i*o-a*s)*t+(a*d-n*o)*r)/g]}function d(e,t,r,a,n,i,o){if(a<0)return null;if(n-t.basey<0)return null;if(a+i+t.width>e.width)return null;if(n+o-t.basey+t.height>e.height)return null;for(var d=1e3,s=null,l=a;l<a+i;l++)for(var u=n;u<n+o;u++){var c=h(e,t,r,l,u,!1,!1);null!=c&&c.sizescore<d&&(d=c.sizescore,s=c)}return s}function s(e,t,r,a,n,i,o){void 0===o&&(o=!1);for(var d="number"!=typeof r[0],s=d?r:[r],l=function(r,a,n){for(var i=null,o=1/0,d=0;d<s.length;d++){var l=h(e,t,s[d],r,a,n,!1);l&&l.sizescore<o&&(i=s[d],o=l.sizescore)}return i},u="",c=a,f=a,p=0,g=[!0,!1];p<g.length;p++){var b=g[p];if((!b||i)&&(b||o))for(var x=0,v=!1,w=!1,y=d?null:r;;){var m=(y=y||l(a+x,n,!b))?h(e,t,y,a+x,n,!b,!0):null;if(null==m){if(d&&!w){y=null,w=!0;continue}if(!v){x+=(b?1:-1)*t.spacewidth,w=!1,v=!0;continue}b?f=a+x-t.spacewidth:c=a+x+t.spacewidth;break}b?u+=(v?" ":"")+m.chr:u=m.chr+(v?" ":"")+u,v=!1,w=!1,x+=(b?1:-1)*m.basechar.width}}return{debugArea:{x:c,y:n-9,w:f-c,h:10},text:u}}function h(e,r,i,o,d,s,h){d-=r.basey;var l=r.basey,u=r.shadow,c=null,f=null;if(t.debug.trackread){var p=o+";"+d+" "+JSON.stringify(i);t.debugout[p]||(t.debugout[p]=[]),c=t.debugout[p]}if(d<0||d+r.height>=e.height)return null;if(s){if(o-r.width<0||o>e.width)return null}else if(o<0||o+r.width>e.width)return null;for(var g=[],b=0;b<r.chars.length;b++){var x=r.chars[b];if(!x.secondary||h){g[b]={score:0,sizescore:0,chr:x};var v=s?o-x.width:o;t.debug.trackread&&(f=new a.ImageData(r.width,r.height));for(var w=0;w<x.pixels.length;){var y=4*(v+x.pixels[w])+(d+x.pixels[w+1])*e.width*4,m=0;if(u){var M=x.pixels[w+3]/255;m=n(e.data[y],e.data[y+1],e.data[y+2],i[0]*M,i[1]*M,i[2]*M,x.pixels[w+2]/255),w+=4}else m=n(e.data[y],e.data[y+1],e.data[y+2],i[0],i[1],i[2],x.pixels[w+2]/255),w+=3;g[b].score+=Math.max(0,m),f&&f.setPixel(x.pixels[w],x.pixels[w+1],[m,m,m,255])}g[b].sizescore=g[b].score-x.bonus,c&&c.push({chr:x.chr,score:g[b].sizescore,rawscore:g[b].score,img:f})}}g.sort(function(e,t){return e.sizescore-t.sizescore}),t.debug.printcharscores&&g.slice(0,5).forEach(function(e){return console.log(e.chr.chr,e.score.toFixed(3),e.sizescore.toFixed(3))});var z=g[0];return!z||z.score>400?null:{chr:z.chr.chr,basechar:z.chr,x:o+0,y:d+l,score:z.score,sizescore:z.sizescore}}t.debug={printcharscores:!1,trackread:!1},t.debugout={},t.debugFont=function(e){for(var t=e.width+2,r=new a.ImageData(t*e.chars.length,e.height+1),n=0;n<r.data.length;n+=4)r.data[n]=r.data[n+1]=r.data[n+2]=0,r.data[n+3]=255;for(n=0;n<e.chars.length;n++)for(var i=n*t,o=e.chars[n],d=0;d<o.pixels.length;d+=e.shadow?4:3)r.setPixel(i+o.pixels[d],o.pixels[d+1],[o.pixels[d+2],o.pixels[d+2],o.pixels[d+2],255]),e.shadow&&r.setPixel(i+o.pixels[d],o.pixels[d+1],[o.pixels[d+3],0,0,255]);r.show()},t.unblendKnownBg=function(e,t,r,n,o,d){if(t&&(e.width!=t.width||e.height!=t.height))throw"bgimg size doesn't match";for(var s=new a.ImageData(e.width,e.height),h=0,l=0;l<e.data.length;l+=4){var u=i(e.data[l],e.data[l+1],e.data[l+2],n,o,d,t.data[l+0],t.data[l+1],t.data[l+2]);if(r){u[2]>.01&&console.log("high error component: "+(100*u[2]).toFixed(1)+"%"),h+=u[2];var c=1-u[1]-Math.abs(u[2]);s.data[l+0]=255*c,s.data[l+1]=u[0]/c*255,s.data[l+2]=s.data[l+0]}else s.data[l+0]=255*u[0],s.data[l+1]=s.data[l+0],s.data[l+2]=s.data[l+0];s.data[l+3]=255}return r&&console.log("avg unblend px error:"+(h/e.width/e.height*100).toFixed(1)+"%"),s},t.unblendTrans=function(e,t,r,n,i){for(var o=new a.ImageData(e.width,e.height),d=r+n+i,s=0;s<e.data.length;s+=4){if(t){var h=e.data[s+0]+e.data[s+1]+e.data[s+2];o.data[s+0]=e.data[s+3],o.data[s+1]=h/d*255,o.data[s+2]=o.data[s+0]}else o.data[s+0]=e.data[s+3],o.data[s+1]=o.data[s+0],o.data[s+2]=o.data[s+0];o.data[s+3]=255}return o},t.canblend=n,t.decompose2col=i,t.decompose3col=o,t.findChar=d,t.findReadLine=function(e,t,r,n,i,o,h){void 0===o&&(o=-1),void 0===h&&(h=-1),-1==o&&(o=t.width+t.spacewidth,n-=Math.ceil(o/2)),-1==h&&(h=7,i-=1);var l=null;if(r.length>1)for(var u=function(e,t,r){if(t.x<0||t.y<0||t.x+t.width>e.width||t.y+t.height>e.height)return null;for(var a=r.map(function(e){return{col:e,score:0}}),n=e.data,i=0,o=a;i<o.length;i++){for(var d=o[i],s=0,h=d.col,l=t.y;l<t.y+t.height;l++)for(var u=t.x;u<t.x+t.width;u++){var c=4*u+4*l*e.width,f=Math.abs(n[c]-h[0])+Math.abs(n[c+1]-h[1])+Math.abs(n[c+2]-h[2]);f<50&&(s+=50-f)}d.score=s}return a}(e,new a.Rect(n,i-t.basey,o,h),r),c=0;c<2&&c<u.length&&null==l;c++)l=d(e,t,u[c].col,n,i,o,h);else l=d(e,t,r[0],n,i,o,h);return null==l?{text:"",debugArea:{x:n,y:i,w:o,h:h}}:s(e,t,r,l.x,l.y,!0,!0)},t.readLine=s,t.readChar=h,t.generatefont=function(e,t,r,a,n,i,o,d){o*=255;for(var s=e.height-1,h=0,l={chars:[],width:0,spacewidth:i,shadow:d,height:0,basey:0},u=!1,c=[],f=0;f<e.width;f++){var p=4*f+4*e.width*(e.height-1);if(255==e.data[p]&&255==e.data[p+3])!1===u&&(u=f);else if(!1!==u){var g=f,b=t[c.length],x={ds:u,de:g,width:g-u,chr:b,bonus:a&&a[b]||0,secondary:-1!=r.indexOf(t[c.length]),pixels:[]};for(c.push(x),l.width=Math.max(l.width,x.width),w=0;w<g-u;w++)for(y=0;y<e.height-1;y++)p=4*(w+u)+y*e.width*4,e.data[p]>=o&&(s=Math.min(s,y),h=Math.max(h,y));u=!1}}for(var v in l.height=h+1-s,l.basey=n-s,c){x=c[v];for(var w=0;w<x.width;w++)for(var y=0;y<h+1-s;y++)p=4*(w+x.ds)+(y+s)*e.width*4,e.data[p]>=o&&(x.pixels.push(w,y),x.pixels.push(e.data[p]),d&&x.pixels.push(e.data[p+1]),x.bonus+=5);delete x.ds,delete x.de,x.bonus=+x.bonus.toFixed(3),l.chars.push(x)}return l}},function(t,r){t.exports=e}])});